<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Spring Cloud Stream Dapr Binder Reference Guide</title>
<link rel="stylesheet" href="css/spring.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}

</style>
<script type="text/javascript">
function addBlockSwitches() {
	for (var primary of document.querySelectorAll('.primary')) {
		var switchItem = createSwitchItem(primary, createBlockSwitch(primary));
		switchItem.item.classList.add("selected");
		var title = primary.querySelector('.title')
		title.remove();
	}
	for (var secondary of document.querySelectorAll('.secondary')) {
		var primary = findPrimary(secondary);
		if (primary === null) {
			console.error("Found secondary block with no primary sibling");
		}
		else {
			var switchItem = createSwitchItem(secondary, primary.querySelector('.switch'));
			switchItem.content.classList.add("hidden");
			primary.append(switchItem.content);
			secondary.remove();
		}
	}
}

function createElementFromHtml(html) {
	var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.firstChild;
}

function createBlockSwitch(primary) {
    var blockSwitch = createElementFromHtml('<div class="switch"></div>');
    primary.prepend(blockSwitch)
	return blockSwitch;
}

function findPrimary(secondary) {
	var candidate = secondary.previousElementSibling;
	while (candidate != null && !candidate.classList.contains('primary')) {
		candidate = candidate.previousElementSibling;
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	var blockName = block.querySelector('.title').textContent;
	var content = block.querySelectorAll('.content').item(0);
	var colist = nextSibling(block, '.colist');
	if (colist != null) {
		content.append(colist);
	}
	var item = createElementFromHtml('<div class="switch--item">' + blockName + '</div>');
	item.dataset.blockName = blockName;
	content.dataset.blockName = blockName;
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function nextSibling(element, selector) {
	var sibling = element.nextElementSibling;
	while (sibling) {
		if (sibling.matches(selector)) {
			return sibling;
		}
		sibling = sibling.nextElementSibling;
	}
}

function globalSwitch() {
	document.querySelectorAll(".switch--item").forEach(function(item) {
		var blockId = blockIdForSwitchItem(item);
		var handler = function(event) {
			selectedText = event.target.textContent;
			window.localStorage.setItem(blockId, selectedText);
			for (var switchItem of document.querySelectorAll(".switch--item")) {
				if (blockIdForSwitchItem(switchItem) === blockId && switchItem.textContent === selectedText) {
					select(switchItem);
				}
			}
		}
		item.addEventListener("click", handler);
		if (item.textContent === window.localStorage.getItem(blockId)) {
			select(item);
		}
	});
}

function select(selected) {
	for (var child of selected.parentNode.children) {
		child.classList.remove("selected");
	}
	selected.classList.add("selected");
	for (var child of selected.parentNode.parentNode.children) {
		if (child.classList.contains("content")) {
			if (selected.dataset.blockName === child.dataset.blockName) {
				child.classList.remove("hidden");
			}
			else {
				child.classList.add("hidden");
			}
		}
	}	
}

function blockIdForSwitchItem(item) {
	idComponents = []
	for (var switchItem of item.parentNode.querySelectorAll(".switch--item")) {
		idComponents.push(switchItem.textContent.toLowerCase());
	}
	return idComponents.sort().join("-")
}

window.onload = function() {
	addBlockSwitches();
	globalSwitch();
};

</script>

</head>
<body id="spring-cloud-stream-binder-dapr-reference" class="book toc2 toc-left">
<div id="header">
<h1>Spring Cloud Stream Dapr Binder Reference Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_1_usage">1. Usage</a></li>
<li><a href="#_2_spring_cloud_stream_dapr_binder_overview">2. Spring Cloud Stream Dapr Binder Overview</a></li>
<li><a href="#_3_configuration_options">3. Configuration Options</a>
<ul class="sectlevel2">
<li><a href="#_3_1_dapr_binder_properties">3.1. Dapr Binder Properties</a></li>
<li><a href="#_3_2_dapr_producer_properties">3.2. Dapr Producer Properties</a></li>
<li><a href="#_3_3_dapr_consumer_properties">3.3. Dapr Consumer Properties</a></li>
<li><a href="#_3_4_dapr_grpc_service_properties">3.4. Dapr Grpc Service Properties</a></li>
<li><a href="#_3_5_dapr_message_headers">3.5. Dapr Message Headers</a></li>
</ul>
</li>
<li><a href="#_4_migration_guide">4. Migration Guide</a>
<ul class="sectlevel2">
<li><a href="#_4_1_migration_from_spring_cloud_azure_stream_binder_event_hubs">4.1 Migration from Spring Cloud Azure Stream Binder Event Hubs</a></li>
</ul>
</li>
<li><a href="#_appendices">Appendices</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_1_usage"><a class="link" href="#_1_usage">1. Usage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use <code>Dapr Binder</code>, you need to clone this project and deploy it into your local maven repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">git clone git@github.com:microsoft/spring-cloud-stream-binder-dapr.git
./mvnw clean install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you need add <code>spring-cloud-stream-binder-dapr</code> as a dependency to your <code>Spring Cloud Stream</code> application, as shown in the following example for Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
   &lt;artifactId&gt;spring-cloud-stream-binder-dapr&lt;/artifactId&gt;
   &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can use the <code>spring-cloud-starter-stream-dapr</code>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
   &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
   &lt;artifactId&gt;spring-cloud-starter-stream-dapr&lt;/artifactId&gt;
   &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_spring_cloud_stream_dapr_binder_overview"><a class="link" href="#_2_spring_cloud_stream_dapr_binder_overview">2. Spring Cloud Stream Dapr Binder Overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://dapr.io">Dapr</a> is an event-driven, portable distributed application runtime, which provides the execution environment that distributed applications need to rely on.</p>
</div>
<div class="paragraph">
<p>As a runtime, <code>Dapr</code> can build our microservices on the cloud or edge computing and provides a unified API interface call for applications upward, making <code>Dapr</code> supporting different programming languages and frameworks.</p>
</div>
<div class="paragraph">
<p><code>Dapr</code> also provides our developers with standard APIs and pluggable and replaceable components to organize various distributed capabilities for our applications, and encapsulate these distributed capabilities as runtimes to simplify distributed application development.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#spring-cloud-stream-reference">Spring Cloud Stream</a> establishes a connection between the application and the middleware, separates the logic of sending and receiving messages with specific middleware from the application, and is finally provided by Binder. Binder shields the details of the underlying MQ message middleware and decouples our application from the specific message middleware.</p>
</div>
<div class="paragraph">
<p>In addition, <code>Spring Cloud Stream</code> abstracts the MQ in the <code>Spring Cloud</code> system and provides a unified API for sending and receiving messages, in order to simplify the development of messages in <code>Spring Cloud</code> applications.</p>
</div>
<div class="paragraph">
<p>Combining <code>Spring Cloud Stream</code> and <code>Dapr</code>, on the one hand <code>Dapr</code> can make up the dependent on a specific middleware library for <code>Spring Cloud Stream</code>, on the other hand, <code>Spring Cloud Stream</code> can help application and <code>Dapr</code> client decoupling. Therefore, the combination of the two is conducive to the maximum decoupling and enhanced features of both sides.</p>
</div>
<div class="paragraph">
<p>The ultimate goal and vision of <a href="https://github.com/microsoft/spring-cloud-stream-binder-dapr">Spring Cloud Stream Dapr Binder</a>(Dapr Binder) is to strip all non-business logic parts from the application, so that developers can pay more attention to the development of business logic.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://user-images.githubusercontent.com/42743274/182814078-45fb0cdc-a2da-40ad-8a4c-ed395b692fa6.png" alt="182814078 45fb0cdc a2da 40ad 8a4c ed395b692fa6">
</div>
</div>
<div class="paragraph">
<p>In <code>Dapr Binder</code>, we regard the entire <a href="https://docs.dapr.io/concepts/overview/#sidecar-architecture">Dapr Sidecar</a> as an MQ. When sending messages, we call Grpc&#8217;s Client, and when receiving messages, we create a Grpc&#8217;s Server and open two interfaces to monitor Dapr&#8217;s calls. One is to tell <code>Dapr</code>, which topics have I subscribed to, and the other is to receive messages from the subscribed topics. This is what we at <code>Dapr Binder</code> do.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_configuration_options"><a class="link" href="#_3_configuration_options">3. Configuration Options</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains the configuration options used by the <code>Dapr Binder</code>.</p>
</div>
<div class="paragraph">
<p>For common configuration options and properties pertaining to the binder, see the <a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/#_configuration_options">binding properties</a> in core documentation.</p>
</div>
<div class="sect2">
<h3 id="_3_1_dapr_binder_properties"><a class="link" href="#_3_1_dapr_binder_properties">3.1. Dapr Binder Properties</a></h3>
<div class="paragraph">
<p>The following properties are available for <code>Dapr Binder</code> only and must be prefixed with <code>spring.cloud.stream.dapr.binder.</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.daprIp</dt>
<dd>
<p>The parameter of the channel, indicating the IP address of the dapr sidecar to which the message is finally sent through the channel.</p>
<div class="paragraph">
<p>Default: <code>127.0.0.1</code></p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.daprPort</dt>
<dd>
<p>The parameter of channel, indicating the port that the dapr sidecar to which the message is finally sent through the channel listens.</p>
<div class="paragraph">
<p>Default: <code>50001</code></p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.negotiationType</dt>
<dd>
<p>NegotiationType decide which connection method to use. TLS and PLAINTEXT are currently available.</p>
<div class="ulist">
<ul>
<li>
<p>PLAINTEXT: Use of a plaintext connection to the server. By default a secure connection mechanism such as TLS will be used.
Should only be used for testing or for APIs where the use of such API or the data exchanged is not sensitive.
This assumes prior knowledge that the target of this channel is using plaintext. It will not perform HTTP/1.1 upgrades.</p>
</li>
<li>
<p>TLS: Makes the client use TLS.</p>
<div class="paragraph">
<p>Default: <code>PLAINTEXT</code></p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.authority</dt>
<dd>
<p>Overrides the authority used with TLS and HTTP virtual hosting. It does not change what host is actually connected to. Is commonly in the form host:port.</p>
<div class="paragraph">
<p>This method is intended for testing, but may safely be used outside of tests as an alternative to DNS overrides.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.defaultLoadBalancingPolicy</dt>
<dd>
<p>Sets the default load-balancing policy that will be used if the service config doesn&#8217;t specify one.</p>
<div class="paragraph">
<p>This method is implemented by all stock channel builders that are shipped with gRPC, but may not be implemented by custom channel builders, in which case this method will throw.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.idleTimeout</dt>
<dd>
<p>Set the duration without ongoing RPCs before going to idle mode.</p>
<div class="paragraph">
<p>In idle mode the channel shuts down all connections, the NameResolver and the LoadBalancer. A new RPC would take the channel out of idle mode. A channel starts in idle mode. Defaults to 30 minutes.</p>
</div>
<div class="paragraph">
<p>This is an advisory option. Do not rely on any specific behavior related to this option.</p>
</div>
<div class="paragraph">
<p>TimeUnit: <code>minutes</code></p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.keepAliveTime</dt>
<dd>
<p>Sets the time without read activity before sending a keepalive ping. An unreasonably small value might be increased, and Long.MAX_VALUE nano seconds or an unreasonably large value will disable keepalive. Defaults to infinite.</p>
<div class="paragraph">
<p>Clients must receive permission from the service owner before enabling this option. Keepalives can increase the load on services and are commonly "invisible" making it hard to notice when they are causing excessive load. Clients are strongly encouraged to use only as small of a value as necessary.</p>
</div>
<div class="paragraph">
<p>TimeUnit: <code>minutes</code></p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.keepAliveTimeout</dt>
<dd>
<p>Sets the time waiting for read activity after sending a keepalive ping. If the time expires without any read activity on the connection, the connection is considered dead. An unreasonably small value might be increased. Defaults to 20 seconds.</p>
<div class="paragraph">
<p>This value should be at least multiple times the RTT to allow for lost packets.</p>
</div>
<div class="paragraph">
<p>TimeUnit: <code>seconds</code></p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.perRpcBufferLimit</dt>
<dd>
<p>Sets the per RPC buffer limit in bytes used for retry. The RPC is not retriable if its buffer limit is exceeded. The implementation may only estimate the buffer size being used rather than count the exact physical memory allocated. It does not have any effect if retry is disabled by the client.</p>
<div class="paragraph">
<p>This method may not work as expected for the current release because retry is not fully implemented yet.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.retryBufferSize</dt>
<dd>
<p>Sets the retry buffer size in bytes. If the buffer limit is exceeded, no RPC could retry at the moment, and in hedging case all hedges but one of the same RPC will cancel. The implementation may only estimate the buffer size being used rather than count the exact physical memory allocated. The method does not have any effect if retry is disabled by the client.</p>
<div class="paragraph">
<p>This method may not work as expected for the current release because retry is not fully implemented yet.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.keepAliveWithoutCalls</dt>
<dd>
<p>Sets whether keepalive will be performed when there are no outstanding RPC on a connection. Defaults to false.</p>
<div class="paragraph">
<p>Clients must receive permission from the service owner before enabling this option. Keepalives on unused connections can easilly accidentally consume a considerable amount of bandwidth and CPU. <code>idleTimeout()</code> should generally be used instead of this option.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.maxInboundMessageSize</dt>
<dd>
<p>Sets the maximum message size allowed to be received on the channel. If not called, defaults to 4 MiB. The default provides protection to clients who haven&#8217;t considered the possibility of receiving large messages while trying to be large enough to not be hit in normal usage.</p>
<div class="paragraph">
<p>This method is advisory, and implementations may decide to not enforce this. Currently, the only known transport to not enforce this is InProcessTransport.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.maxInboundMetadataSize</dt>
<dd>
<p>Sets the maximum size of metadata allowed to be received. Integer.MAX_VALUE disables the enforcement. The default is implementation-dependent, but is not generally less than 8 KiB and may be unlimited.</p>
<div class="paragraph">
<p>This is cumulative size of the metadata. The precise calculation is implementation-dependent, but implementations are encouraged to follow the calculation used for <a href="https://httpwg.org/specs/rfc7540.html#rfc.section.6.5.2">HTTP/2&#8217;s SETTINGS_MAX_HEADER_LIST_SIZE</a> . It sums the bytes from each entry&#8217;s key and value, plus 32 bytes of overhead per entry.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.maxRetryAttempts</dt>
<dd>
<p>Sets the maximum number of retry attempts that may be configured by the service config. If the service config specifies a larger value it will be reduced to this value. Setting this number to zero is not effectively the same as disableRetry() because the former does not disable <a href="https://github.com/grpc/proposal/blob/master/A6-client-retries.md#transparent-retries">transparent retry</a> .</p>
<div class="paragraph">
<p>This method may not work as expected for the current release because retry is not fully implemented yet.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.maxHedgedAttempts</dt>
<dd>
<p>Sets the maximum number of hedged attempts that may be configured by the service config. If the service config specifies a larger value it will be reduced to this value.</p>
<div class="paragraph">
<p>This method may not work as expected for the current release because retry is not fully implemented yet.</p>
</div>
</dd>
<dt class="hdlist1">spring.cloud.stream.dapr.binder.maxTraceEvents</dt>
<dd>
<p>Sets the maximum number of channel trace events to keep in the tracer for each channel or subchannel. If set to 0, channel tracing is effectively disabled.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_3_2_dapr_producer_properties"><a class="link" href="#_3_2_dapr_producer_properties">3.2. Dapr Producer Properties</a></h3>
<div class="paragraph">
<p>The following properties are available for <code>Dapr</code> producers only and must be prefixed with <code>spring.cloud.stream.dapr.bindings.&lt;bindingTarget&gt;.producer.</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">pubsubName</dt>
<dd>
<p>Specifies the name of the Pub/Sub component.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
PubsubName must be specified and has no default value.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_3_3_dapr_consumer_properties"><a class="link" href="#_3_3_dapr_consumer_properties">3.3. Dapr Consumer Properties</a></h3>
<div class="paragraph">
<p>The following properties are available for <code>Dapr</code> consumers only and must be prefixed with <code>spring.cloud.stream.dapr.bindings.&lt;bindingTarget&gt;.consumer.</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">pubsubName</dt>
<dd>
<p>Specifies the name of the Pub/Sub component.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
PubsubName must be specified and has no default value.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_3_4_dapr_grpc_service_properties"><a class="link" href="#_3_4_dapr_grpc_service_properties">3.4. Dapr Grpc Service Properties</a></h3>
<div class="paragraph">
<p>Dapr Binder receives messages by starting a Grpc Server, and Grpc Server depends on the <a href="https://github.com/yidongnan/grpc-spring-boot-starter">grpc-spring-boot-starter</a> dependency. The relevant parameter configuration can be referred to <a href="https://yidongnan.github.io/grpc-spring-boot-starter/en/server/configuration.html">Configuration of Grpc Spring Boot Starter</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_3_5_dapr_message_headers"><a class="link" href="#_3_5_dapr_message_headers">3.5. Dapr Message Headers</a></h3>
<div class="paragraph">
<p>The following table illustrates how <code>Dapr</code> message properties are mapped to Spring message headers.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dapr Message Properties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring Message Header Constants</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">contentType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DaprHeaders#CONTENT_TYPE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The contentType tells Dapr which content type your data adheres to when constructing a CloudEvent envelope.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ttlInSeconds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DaprHeaders#TTL_IN_SECONDS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of seconds for the message to expire.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rawPayload</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DaprHeaders#RAW_PAY_LOAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determine if Dapr should publish the event without wrapping it as CloudEvent. Not using CloudEvents disables support for tracing, event deduplication per messageId, content-type metadata, and any other features built using the CloudEvent schema.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">specifiedBrokerMetadata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DaprHeaders#SPECIFIED_Broker_METADATA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Map&lt;String, String&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some metadata parameters are available based on each pubsub broker component.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_migration_guide"><a class="link" href="#_4_migration_guide">4. Migration Guide</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_4_1_migration_from_spring_cloud_azure_stream_binder_event_hubs"><a class="link" href="#_4_1_migration_from_spring_cloud_azure_stream_binder_event_hubs">4.1 Migration from Spring Cloud Azure Stream Binder Event Hubs</a></h3>
<div class="sect3">
<h4 id="_1_update_dependency"><a class="link" href="#_1_update_dependency">1. Update dependency</a></h4>
<div class="paragraph">
<p>Remove <code>spring-cloud-azure-stream-binder-eventhubs</code> dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-azure-stream-binder-eventhubs&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add <code>spring-cloud-stream-binder-dapr</code> dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">&lt;dependency&gt;
  &lt;groupId&gt;com.azure.spring&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-stream-binder-dapr&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_2_update_application_yaml"><a class="link" href="#_2_update_application_yaml">2. Update application.yaml</a></h4>
<div class="ulist">
<ul>
<li>
<p>Remove all configurations prefixed with <code>spring.cloud.azure.eventhubs.</code>.</p>
</li>
<li>
<p>Remove all configurations prefixed with <code>spring.cloud.stream.eventhubs.</code>.</p>
</li>
<li>
<p>Add configurations prefixed with <code>spring.cloud.stream.dapr.</code> and specify pubsubName.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The final pubsub.yaml is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spring.cloud.stream.bindings.&lt;binding&gt;.destination</code> is configured the topic specified for sending messages.</p>
</li>
<li>
<p><code>spring.cloud.stream.dapr.bindings.&lt;binding&gt;.producer.pubsubName</code> is configured the name of the Pub/Sub component specified for sending messages.</p>
</li>
<li>
<p><code>spring.cloud.stream.dapr.bindings.&lt;binding&gt;.consumer.pubsubName</code> is configured the name of the Pub/Sub component specified for receiving messages.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring:
  cloud:
    stream:
      function:
        definition: supply;consume
      bindings:
        supply-out-0:
          destination: &lt;AZURE_EVENTHUB_NAME&gt;
        consume-in-0:
          destination: &lt;AZURE_EVENTHUB_NAME&gt;
      dapr:
        bindings:
          supply-out-0:
            producer:
              pubsubName: eventhubs-pubsub
          consume-in-0:
            consumer:
              pubsubName: eventhubs-pubsub</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_3_configure_azure_event_hubs_component"><a class="link" href="#_3_configure_azure_event_hubs_component">3. Configure Azure Event Hubs component</a></h4>
<div class="paragraph">
<p><code>Dapr</code> integrates with <code>Pub/Sub</code> message buses to provide applications with the ability to create event-driven, loosely coupled architectures where producers send events to consumers via topics.</p>
</div>
<div class="paragraph">
<p><code>Dapr</code> supports the configuration of multiple, named, <code>Pub/Sub components</code> per application. Each <code>Pub/Sub component</code> has a name and this name is used when publishing a message topic.</p>
</div>
<div class="paragraph">
<p><code>Pub/Sub components</code> are extensible. A list of support <code>Pub/Sub components</code> is <a href="https://docs.dapr.io/reference/components-reference/supported-pubsub/">here</a> and the implementations can be found in the <a href="https://github.com/dapr/components-contrib">components-contrib repo</a>.</p>
</div>
<div class="paragraph">
<p>In this example, we configure the <code>Azure Event Hubs Pub/Sub component</code> described using the <code>pubsub.yaml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: eventhubs-pubsub
spec:
  type: pubsub.azure.eventhubs
  version: v1
  metadata:
    - name: connectionString
      value: "&lt;AZURE_CONNECTION_STRING&gt;"
    - name: storageAccountName
      value: "&lt;AZURE_STORAGE_ACCOUNT_NAME&gt;"
    - name: storageAccountKey
      value: "&lt;AZURE_STORAGE_ACCOUNT_KEY&gt;"
    - name: storageContainerName
      value: "&lt;AZURE_STORAGE_CONTAINER_NAME&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the instructions <a href="https://docs.microsoft.com/azure/storage/common/storage-account-keys-manage?tabs=azure-portal">here</a> to manage the storage account access keys.
See <a href="https://docs.microsoft.com/azure/event-hubs/event-hubs-get-connection-string">here</a> on how to get the Event Hubs connection string.</p>
</div>
</div>
<div class="sect3">
<h4 id="_4_run_application_with_dapr_sidecar"><a class="link" href="#_4_run_application_with_dapr_sidecar">4. Run application with Dapr sidecar</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">dapr run --app-id dapr-app --app-port 9090 --components-path ${componentsPath}  --app-protocol grpc --dapr-grpc-port ${daprPort} mvn spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command specifies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the id for your application with <code>--app-id dapr-app</code>, used for service discovery.</p>
</li>
<li>
<p>the port your application is listening on (default -1) with <code>--app-port 9090</code>.</p>
</li>
<li>
<p>the path for components directory with <code>--components-path ./components</code>.</p>
</li>
<li>
<p>the protocol (gRPC or HTTP) Dapr with <code>--app-protocol grpc</code> uses to talk to the application.</p>
</li>
<li>
<p>the gRPC port for Dapr to listen on (default -1) with <code>--dapr-grpc-port 50001</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_5_clean_up"><a class="link" href="#_5_clean_up">5. Clean Up</a></h4>
<div class="paragraph">
<p>To stop your services from running, simply stop the <code>dapr run</code> process. Alternatively, you can spin down your services with the Dapr CLI <code>dapr stop</code> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">dapr stop --app-id dapr-app</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendices"><a class="link" href="#_appendices">Appendices</a></h2>
<div class="sectionbody">
<div id="building" class="paragraph">
<p>In the maven of the project we use <code>Spring Cloud Stream</code> as parent, thus to build it locally, you can refer to <a href="https://github.com/spring-cloud/spring-cloud-stream#building">Spring Cloud Stream</a>.</p>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="js/toc.js"></script>
</body>
</html>